<%- include('../partials/header', {title: 'Manager Dashboard - Sports Amigo', headerType: 'manager'}) %>
<%- include('../partials/navbar', { user: user }) %>


<div class="row">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h3 class="mb-0">Browse Events</h3>
            </div>
            <div class="card-body">
                <!-- Add navigation test buttons at the top of the page -->
                <div class="mb-4">
                    <h4>Navigation Test:</h4>
                    <div class="btn-group">
                        <a href="/manager/player-performance" class="btn btn-primary">Go to Performance</a>
                        <a href="/manager/my-team" class="btn btn-success">Go to My Team</a>
                        <a href="/manager" class="btn btn-info">Go to Dashboard</a>
                    </div>
                </div>
                
                <!-- Search and Filter -->
                <div class="row mb-4">
                    <div class="col-md-8">
                        <div class="input-group">
                            <input type="text" class="form-control" id="eventSearchInput" placeholder="Search for events...">
                            <button class="btn btn-primary" id="searchButton">
                                <i class="bi bi-search"></i> Search
                            </button>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <select class="form-select" id="sportFilter">
                            <option value="">All Sports</option>
                            <option value="Basketball">Basketball</option>
                            <option value="Football">Football</option>
                            <option value="Cricket">Cricket</option>
                            <option value="Tennis">Tennis</option>
                            <option value="Swimming">Swimming</option>
                            <option value="Volleyball">Volleyball</option>
                        </select>
                    </div>
                </div>
                
                <!-- Events List -->
                <div id="eventsContainer">
                    <% if (locals.events && events.length > 0) { %>
                        <div class="row">
                            <% events.forEach(event => { %>
                                <div class="col-md-6 col-lg-4 mb-4">
                                    <div class="card h-100 event-card" data-sport="<%= (event.sport || '').toLowerCase() %>">
                                        <div class="card-header bg-<%= event.sport === 'Basketball' ? 'primary' : event.sport === 'Football' ? 'success' : event.sport === 'Cricket' ? 'warning' : 'info' %> text-white">
                                            <%= event.sport %>
                                        </div>
                                        <div class="card-body">
                                            <h5 class="card-title"><%= event.name %></h5>
                                            <p class="card-text text-muted small"><%= event.description ? event.description.substring(0, 100) + '...' : 'No description available' %></p>
                                            <div class="d-flex justify-content-between mb-2">
                                                <span><i class="bi bi-calendar-event"></i> <%= new Date(event.date).toLocaleDateString() %></span>
                                                <span><i class="bi bi-geo-alt"></i> <%= event.location %></span>
                                            </div>
                                            <div class="d-flex justify-content-between mb-2">
                                                <span><i class="bi bi-people"></i> <%= event.current_participants %>/<%= event.max_participants %></span>
                                                <span class="badge bg-<%= event.status === 'Open' ? 'success' : 'warning' %>"><%= event.status %></span>
                                            </div>
                                            <div class="mb-3">
                                                <span><i class="bi bi-person"></i> Organizer: <%= event.organizer || 'Unknown' %></span>
                                            </div>
                                            <div class="d-grid gap-2">
                                                <% if (event.isRegistered) { %>
                                                    <button class="btn btn-success btn-sm" disabled>
                                                        <i class="bi bi-check-circle-fill"></i> Already Registered
                                                    </button>
                                                <% } else { %>
                                                    <a href="/manager/event/<%= event.id %>/details" class="btn btn-primary btn-sm">
                                                        More Details
                                                    </a>
                                                <% } %>
                                            </div>
                                        </div>
                                        <div class="card-footer text-muted">
                                            <small>Registration Deadline: <%= event.registration_deadline ? new Date(event.registration_deadline).toLocaleDateString() : 'N/A' %></small>
                                        </div>
                                    </div>
                                </div>
                            <% }); %>
                        </div>
                    <% } else { %>
                        <div class="alert alert-info">
                            <p>No events are currently available. Please check back later.</p>
                        </div>
                    <% } %>
                    
                    <!-- No events message, hidden by default -->
                    <div id="noEventsMessage" class="alert alert-info d-none">
                        <p>No events match your search criteria. Please try different keywords or filters.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add a single modal for event registration -->
<div class="modal fade" id="registerEventModal" tabindex="-1" aria-labelledby="registerEventModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="registerEventModalLabel">Register Team for <span id="registerEventName"></span></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="registrationForm" action="/manager/event/1/register" method="POST">
                    <div class="mb-3">
                        <label for="teamSelect" class="form-label">Select Team</label>
                        <select class="form-select" id="teamSelect" name="team_id" required>
                            <option value="">-- Select a team --</option>
                            <% if (locals.teams && teams.length > 0) { %>
                                <% teams.forEach(team => { %>
                                    <option value="<%= team.id %>"><%= team.name %></option>
                                <% }); %>
                            <% } else { %>
                                <option value="1">Blazing Hawks</option>
                            <% } %>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="additionalNotes" class="form-label">Additional Notes (Optional)</label>
                        <textarea class="form-control" id="additionalNotes" name="notes" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="submitRegistration">Register Team</button>
            </div>
        </div>
    </div>
</div>

<!-- Include Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Variables for search and filter elements
        const searchInput = document.getElementById('eventSearchInput');
        const searchButton = document.getElementById('searchButton');
        const sportFilter = document.getElementById('sportFilter');
        const eventCards = document.querySelectorAll('.event-card');
        const noEventsMessage = document.getElementById('noEventsMessage');
        
        // 1. Search functionality
        function filterEvents() {
            const searchTerm = searchInput.value.toLowerCase();
            const sportType = sportFilter.value.toLowerCase();
            let visibleCount = 0;
            
            eventCards.forEach(card => {
                const eventName = card.querySelector('.card-title').textContent.toLowerCase();
                const eventDescription = card.querySelector('.card-text').textContent.toLowerCase();
                const eventSport = card.getAttribute('data-sport').toLowerCase();
                
                const matchesSearch = !searchTerm || eventName.includes(searchTerm) || eventDescription.includes(searchTerm);
                const matchesSport = sportType === '' || eventSport === sportType;
                
                if (matchesSearch && matchesSport) {
                    card.style.display = 'block';
                    visibleCount++;
                } else {
                    card.style.display = 'none';
                }
            });
            
            // Show/hide "no events" message
            if (visibleCount === 0 && (searchTerm || sportType !== '')) {
                noEventsMessage.classList.remove('d-none');
            } else {
                noEventsMessage.classList.add('d-none');
            }
        }
        
        // Add event listeners for search and filter
        if (searchButton) {
            searchButton.addEventListener('click', filterEvents);
        }
        
        if (searchInput) {
            searchInput.addEventListener('input', filterEvents);
            searchInput.addEventListener('keyup', function(e) {
                if (e.key === 'Enter') {
                    filterEvents();
                }
            });
        }
        
        if (sportFilter) {
            sportFilter.addEventListener('change', filterEvents);
        }
        
        // 2. Register Team button functionality
        const registerButtons = document.querySelectorAll('.register-btn');
        registerButtons.forEach(button => {
            button.addEventListener('click', function() {
                const eventId = this.getAttribute('data-event-id');
                const eventName = this.getAttribute('data-event-name');
                
                // Update modal content
                document.getElementById('registerEventName').textContent = eventName;
                document.getElementById('registrationForm').action = `/manager/event/${eventId}/register`;
                
                // Show modal
                const modal = new bootstrap.Modal(document.getElementById('registerEventModal'));
                modal.show();
            });
        });
        
        // 3. Submit Registration form
        const submitRegistrationBtn = document.getElementById('submitRegistration');
        if (submitRegistrationBtn) {
            submitRegistrationBtn.addEventListener('click', function() {
                const form = document.getElementById('registrationForm');
                
                if (form.checkValidity()) {
                    this.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Registering...';
                    this.disabled = true;
                    
                    form.submit();
                } else {
                    form.reportValidity();
                }
            });
        }
        
        const detailsLinks = document.querySelectorAll('.btn-outline-secondary');
        detailsLinks.forEach(link => {
            link.addEventListener('click', function() {
                console.log('Viewing details for event:', this.closest('.event-card').querySelector('.card-title').textContent);
            });
        });
        
        document.querySelectorAll('.modal-content').forEach(content => {
            content.addEventListener('click', function(event) {
                event.stopPropagation();
            });
        });
        
        filterEvents();
    });
</script> 

<%- include('../partials/footer') %>