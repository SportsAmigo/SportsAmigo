<!-- Transactions Page -->
<div class="container-fluid mt-4">
    <!-- Search and Filters -->
    <div class="row mb-4">
        <div class="col-md-4">
            <div class="input-group">
                <input type="text" class="form-control" placeholder="Search orders..." id="transactionSearchInput">
                <button class="btn btn-primary" type="button">
                    <i class="fas fa-search"></i>
                </button>
            </div>
        </div>
        <div class="col-md-8 text-end">
            <div class="btn-group me-2">
                <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                    <i class="fas fa-filter"></i> Status Filter
                </button>
                <ul class="dropdown-menu">
                    <li><a class="dropdown-item" href="?status=">All Status</a></li>
                    <li><a class="dropdown-item" href="?status=Placed">Placed</a></li>
                    <li><a class="dropdown-item" href="?status=Confirmed">Confirmed</a></li>
                    <li><a class="dropdown-item" href="?status=Processing">Processing</a></li>
                    <li><a class="dropdown-item" href="?status=Shipped">Shipped</a></li>
                    <li><a class="dropdown-item" href="?status=Delivered">Delivered</a></li>
                    <li><a class="dropdown-item" href="?status=Cancelled">Cancelled</a></li>
                </ul>
            </div>
        </div>
    </div>

    <!-- Transaction Statistics -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card bg-primary text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="card-title">Total Orders</h6>
                            <h3 class="mb-0"><%= pagination ? pagination.total : 0 %></h3>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-shopping-cart fs-2"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-success text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="card-title">Total Revenue</h6>
                            <h3 class="mb-0">$<%= orders ? orders.reduce((sum, order) => sum + order.totalAmount, 0).toFixed(2) : '0.00' %></h3>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-dollar-sign fs-2"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-info text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="card-title">Pending Orders</h6>
                            <h3 class="mb-0"><%= orders ? orders.filter(order => order.status === 'Placed' || order.status === 'Confirmed').length : 0 %></h3>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-clock fs-2"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-warning text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="card-title">Delivered Orders</h6>
                            <h3 class="mb-0"><%= orders ? orders.filter(order => order.status === 'Delivered').length : 0 %></h3>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-check-circle fs-2"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Transactions Table -->
    <div class="card shadow-sm">
        <div class="card-header bg-white d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Transaction History</h5>
            <span class="badge bg-primary"><%= orders ? orders.length : 0 %> Orders on this page</span>
        </div>
        <div class="card-body p-0">
            <% if (orders && orders.length > 0) { %>
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>Order #</th>
                                <th>Customer</th>
                                <th>Items</th>
                                <th>Total Amount</th>
                                <th>Payment Method</th>
                                <th>Status</th>
                                <th>Date</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <% orders.forEach(order => { %>
                                <tr>
                                    <td>
                                        <strong><%= order.orderNumber %></strong>
                                    </td>
                                    <td>
                                        <div>
                                            <strong><%= order.customerInfo ? order.customerInfo.fullName : (order.userId ? order.userId.first_name + ' ' + order.userId.last_name : 'Unknown') %></strong>
                                            <br>
                                            <small class="text-muted"><%= order.userId ? order.userId.email : order.customerInfo ? order.customerInfo.phone : '' %></small>
                                        </div>
                                    </td>
                                    <td>
                                        <span class="badge bg-secondary"><%= order.itemCount %> items</span>
                                        <br>
                                        <small class="text-muted">
                                            <% if (order.orderItems && order.orderItems.length > 0) { %>
                                                <%= order.orderItems[0].name %><% if (order.orderItems.length > 1) { %> + <%= order.orderItems.length - 1 %> more<% } %>
                                            <% } %>
                                        </small>
                                    </td>
                                    <td>
                                        <strong>$<%= order.totalAmount.toFixed(2) %></strong>
                                    </td>
                                    <td>
                                        <span class="badge bg-light text-dark">
                                            <i class="fas fa-credit-card"></i> <%= order.paymentMethod %>
                                        </span>
                                    </td>
                                    <td>
                                        <% 
                                        let statusClass = '';
                                        switch(order.status) {
                                            case 'Placed': statusClass = 'bg-secondary'; break;
                                            case 'Confirmed': statusClass = 'bg-info'; break;
                                            case 'Processing': statusClass = 'bg-warning'; break;
                                            case 'Shipped': statusClass = 'bg-primary'; break;
                                            case 'Delivered': statusClass = 'bg-success'; break;
                                            case 'Cancelled': statusClass = 'bg-danger'; break;
                                            default: statusClass = 'bg-secondary';
                                        }
                                        %>
                                        <span class="badge <%= statusClass %>"><%= order.status %></span>
                                    </td>
                                    <td>
                                        <div>
                                            <%= new Date(order.orderDate).toLocaleDateString() %>
                                            <br>
                                            <small class="text-muted"><%= new Date(order.orderDate).toLocaleTimeString() %></small>
                                        </div>
                                    </td>
                                    <td>
                                        <div class="btn-group btn-group-sm">
                                            <button class="btn btn-outline-primary" onclick="viewOrder('<%= order._id %>')">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                            <% if (order.status !== 'Delivered' && order.status !== 'Cancelled') { %>
                                                <button class="btn btn-outline-secondary" onclick="updateOrderStatus('<%= order._id %>')">
                                                    <i class="fas fa-edit"></i>
                                                </button>
                                            <% } %>
                                        </div>
                                    </td>
                                </tr>
                            <% }) %>
                        </tbody>
                    </table>
                </div>
            <% } else { %>
                <div class="text-center py-4">
                    <i class="fas fa-receipt fa-3x text-muted mb-3"></i>
                    <h5 class="text-muted">No transactions found</h5>
                    <p class="text-muted">There are no transactions matching your current filters.</p>
                </div>
            <% } %>
        </div>
        
        <!-- Pagination -->
        <% if (pagination && pagination.pages > 1) { %>
            <div class="card-footer bg-white">
                <nav aria-label="Transaction pagination">
                    <ul class="pagination justify-content-center mb-0">
                        <li class="page-item <%= pagination.current <= 1 ? 'disabled' : '' %>">
                            <a class="page-link" href="?page=<%= pagination.current - 1 %><%= filters.status ? '&status=' + filters.status : '' %><%= filters.dateFrom ? '&dateFrom=' + filters.dateFrom : '' %><%= filters.dateTo ? '&dateTo=' + filters.dateTo : '' %>" tabindex="-1">Previous</a>
                        </li>
                        <% for (let i = Math.max(1, pagination.current - 2); i <= Math.min(pagination.pages, pagination.current + 2); i++) { %>
                            <li class="page-item <%= i === pagination.current ? 'active' : '' %>">
                                <a class="page-link" href="?page=<%= i %><%= filters.status ? '&status=' + filters.status : '' %><%= filters.dateFrom ? '&dateFrom=' + filters.dateFrom : '' %><%= filters.dateTo ? '&dateTo=' + filters.dateTo : '' %>"><%= i %></a>
                            </li>
                        <% } %>
                        <li class="page-item <%= pagination.current >= pagination.pages ? 'disabled' : '' %>">
                            <a class="page-link" href="?page=<%= pagination.current + 1 %><%= filters.status ? '&status=' + filters.status : '' %><%= filters.dateFrom ? '&dateFrom=' + filters.dateFrom : '' %><%= filters.dateTo ? '&dateTo=' + filters.dateTo : '' %>">Next</a>
                        </li>
                    </ul>
                </nav>
            </div>
        <% } %>
    </div>
</div>

<!-- Order Details Modal -->
<div class="modal fade" id="orderDetailsModal" tabindex="-1" aria-labelledby="orderDetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="orderDetailsModalLabel">Order Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="orderDetailsContent">
                <!-- Order details will be loaded here -->
            </div>
        </div>
    </div>
</div>

<!-- Update Status Modal -->
<div class="modal fade" id="updateStatusModal" tabindex="-1" aria-labelledby="updateStatusModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="updateStatusModalLabel">Update Order Status</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="updateStatusForm">
                    <input type="hidden" id="updateOrderId" name="orderId">
                    <div class="mb-3">
                        <label for="newStatus" class="form-label">New Status</label>
                        <select class="form-select" id="newStatus" name="status" required>
                            <option value="Placed">Placed</option>
                            <option value="Confirmed">Confirmed</option>
                            <option value="Processing">Processing</option>
                            <option value="Shipped">Shipped</option>
                            <option value="Delivered">Delivered</option>
                            <option value="Cancelled">Cancelled</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveStatusUpdate()">Update Status</button>
            </div>
        </div>
    </div>
</div>

<script>
function viewOrder(orderId) {
    // Load order details via AJAX
    fetch(`/admin/api/orders/${orderId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const order = data.order;
                const content = `
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Order Information</h6>
                            <p><strong>Order Number:</strong> ${order.orderNumber}</p>
                            <p><strong>Status:</strong> <span class="badge bg-primary">${order.status}</span></p>
                            <p><strong>Order Date:</strong> ${new Date(order.orderDate).toLocaleString()}</p>
                            <p><strong>Total Amount:</strong> $${order.totalAmount.toFixed(2)}</p>
                        </div>
                        <div class="col-md-6">
                            <h6>Customer Information</h6>
                            <p><strong>Name:</strong> ${order.customerInfo ? order.customerInfo.fullName : 'N/A'}</p>
                            <p><strong>Phone:</strong> ${order.customerInfo ? order.customerInfo.phone : 'N/A'}</p>
                            <p><strong>Address:</strong> ${order.customerInfo ? order.customerInfo.address : 'N/A'}</p>
                        </div>
                    </div>
                    <hr>
                    <h6>Order Items</h6>
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Item</th>
                                    <th>Quantity</th>
                                    <th>Price</th>
                                    <th>Total</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${order.orderItems.map(item => `
                                    <tr>
                                        <td>${item.name}</td>
                                        <td>${item.quantity}</td>
                                        <td>$${item.price.toFixed(2)}</td>
                                        <td>$${(item.price * item.quantity).toFixed(2)}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
                document.getElementById('orderDetailsContent').innerHTML = content;
                new bootstrap.Modal(document.getElementById('orderDetailsModal')).show();
            }
        })
        .catch(error => {
            console.error('Error loading order details:', error);
            alert('Failed to load order details');
        });
}

function updateOrderStatus(orderId) {
    document.getElementById('updateOrderId').value = orderId;
    new bootstrap.Modal(document.getElementById('updateStatusModal')).show();
}

function saveStatusUpdate() {
    const orderId = document.getElementById('updateOrderId').value;
    const newStatus = document.getElementById('newStatus').value;
    
    fetch(`/admin/api/orders/${orderId}/status`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ status: newStatus })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload(); // Refresh the page to show updated status
        } else {
            alert('Failed to update order status');
        }
    })
    .catch(error => {
        console.error('Error updating order status:', error);
        alert('Failed to update order status');
    });
}

function exportTransactions() {
    const currentUrl = new URL(window.location);
    currentUrl.pathname = '/admin/api/transactions/export';
    window.open(currentUrl.toString(), '_blank');
}

// Search functionality
document.getElementById('transactionSearchInput').addEventListener('input', function(e) {
    const searchTerm = e.target.value.toLowerCase();
    const rows = document.querySelectorAll('tbody tr');
    
    rows.forEach(row => {
        const text = row.textContent.toLowerCase();
        row.style.display = text.includes(searchTerm) ? '' : 'none';
    });
});
</script>