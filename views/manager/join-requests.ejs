<%- include('../partials/header', {title: 'Manager Dashboard - Sports Amigo', headerType: 'manager'}) %>
<%- include('../partials/navbar', { user: user }) %>


<!-- Manager Join Requests Page -->
<div class="container-fluid">
    <div class="row mb-4">
        <div class="col-12">
            <div class="card bg-primary text-white">
                <div class="card-body">
                    <h2 class="mb-0"><i class="fas fa-user-plus me-2"></i> Team Join Requests</h2>
                    <p class="lead mt-2 mb-0">
                        Review and manage requests from players who want to join your teams.
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Error/Success Messages -->
    <% if (messages.error) { %>
    <div class="alert alert-danger" role="alert">
        <%= messages.error %>
    </div>
    <% } %>
    
    <% if (messages.success) { %>
    <div class="alert alert-success" role="alert">
        <%= messages.success %>
    </div>
    <% } %>

    <!-- Join Requests Section -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <% if (requests && requests.length > 0) { %>
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead class="table-dark">
                                    <tr>
                                        <th>Player</th>
                                        <th>Team</th>
                                        <th>Sport</th>
                                        <th>Request Date</th>
                                        <th class="text-center">Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <% requests.forEach(request => { %>
                                        <tr>
                                            <td>
                                                <%= request.player_first_name %> <%= request.player_last_name %>
                                                <small class="text-muted d-block"><%= request.player_email %></small>
                                            </td>
                                            <td><%= request.team_name %></td>
                                            <td><span class="badge bg-primary"><%= request.sport_type %></span></td>
                                            <td><%= new Date(request.request_date).toLocaleDateString() %></td>
                                            <td class="text-center">
                                                <form action="/manager/process-request" method="POST" class="d-inline">
                                                    <input type="hidden" name="requestId" value="<%= request.request_id %>">
                                                    <input type="hidden" name="action" value="approve">
                                                    <button type="submit" class="btn btn-success btn-sm">
                                                        <i class="fas fa-check me-1"></i> Approve
                                                    </button>
                                                </form>
                                                <form action="/manager/process-request" method="POST" class="d-inline ms-2">
                                                    <input type="hidden" name="requestId" value="<%= request.request_id %>">
                                                    <input type="hidden" name="action" value="reject">
                                                    <button type="submit" class="btn btn-danger btn-sm">
                                                        <i class="fas fa-times me-1"></i> Reject
                                                    </button>
                                                </form>
                                            </td>
                                        </tr>
                                    <% }); %>
                                </tbody>
                            </table>
                        </div>
                    <% } else { %>
                        <div class="alert alert-info text-center" role="alert">
                            <i class="fas fa-info-circle me-2"></i> No pending join requests at this time.
                        </div>
                    <% } %>
                </div>
            </div>
        </div>
    </div>

    <!-- Information Card -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card bg-light">
                <div class="card-body">
                    <h5 class="card-title"><i class="fas fa-info-circle me-2"></i> About Join Requests</h5>
                    <p class="card-text">
                        When you approve a request, the player will be added to your team immediately. 
                        They will be able to see team events and participate in team activities.
                    </p>
                    <p class="card-text mb-0">
                        Rejected requests can be submitted again by the player if they wish to join your team in the future.
                    </p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Request Details Modal -->
<div class="modal fade" id="requestDetailsModal" tabindex="-1" aria-labelledby="requestDetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="requestDetailsModalLabel">Join Request Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="requestDetailsBody">
                <!-- Content will be populated by JavaScript -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <div id="requestActionButtons"></div>
            </div>
        </div>
    </div>
</div>

<script>
    // Function to show request details in modal
    function showRequestDetails(requestId, playerName, teamName, sport, requestDate) {
        const modalBody = document.getElementById('requestDetailsBody');
        const actionButtons = document.getElementById('requestActionButtons');
        
        modalBody.innerHTML = `
            <p><strong>Player:</strong> ${playerName}</p>
            <p><strong>Team:</strong> ${teamName}</p>
            <p><strong>Sport:</strong> ${sport}</p>
            <p><strong>Requested On:</strong> ${new Date(requestDate).toLocaleString()}</p>
        `;
        
        actionButtons.innerHTML = `
            <form action="/manager/join-requests/approve/${requestId}" method="POST" class="d-inline me-2">
                <button type="submit" class="btn btn-success">Approve</button>
            </form>
            <form action="/manager/join-requests/reject/${requestId}" method="POST" class="d-inline">
                <button type="submit" class="btn btn-danger">Reject</button>
            </form>
        `;
        
        const modal = new bootstrap.Modal(document.getElementById('requestDetailsModal'));
        modal.show();
    }
</script> 

<%- include('../partials/footer') %>