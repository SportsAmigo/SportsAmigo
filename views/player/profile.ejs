<div class="row mb-4">
    <% 
    // Check if the profile is incomplete (missing essential fields)
    const isNewUser = !profile.name || !profile.phone || !profile.age || !profile.address || !profile.bio;
    %>
    
    <% if (isNewUser) { %>
    <div class="col-12 mb-4">
        <div class="alert alert-info d-flex align-items-center" role="alert">
            <i class="bi bi-info-circle-fill me-2 fs-4"></i>
            <div>
                <h4 class="alert-heading">Welcome to Sports Amigo!</h4>
                <p class="mb-0">Please complete your profile details below before proceeding. This information helps us personalize your experience and connect you with suitable teams and events.</p>
            </div>
            <button type="button" class="btn btn-primary ms-auto" id="completeProfileBtn">Complete Profile</button>
        </div>
    </div>
    <% } %>
    
    <div class="col">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h3 class="mb-0">My Profile</h3>
            </div>
            <div class="card-body">
                <div class="row">
                    <!-- Profile Information -->
                    <div class="col-md-4">
                        <div class="card border-0 shadow-sm mb-4">
                            <div class="card-body text-center">
                                <div class="mb-4">
                                    <% if (profile.profile_image || profile.photoUrl) { %>
                                        <img src="<%= profile.profile_image || profile.photoUrl %>" alt="Profile Picture" class="rounded-circle img-thumbnail" width="150" height="150" style="object-fit: cover;">
                                    <% } else { %>
                                        <img src="/images/default-avatar.png" alt="Profile Picture" class="rounded-circle img-thumbnail" width="150" height="150">
                                    <% } %>
                                </div>
                                <h4 class="mb-0"><%= profile.name || 'Player' %></h4>
                                <p class="text-muted"><%= profile.email %></p>
                                <div class="d-grid gap-2 mt-3">
                                    <button class="btn btn-primary" id="changePhotoBtn" data-bs-toggle="modal" data-bs-target="#changePhotoModal">Change Profile Picture</button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card border-0 shadow-sm">
                            <div class="card-header bg-light">
                                <h5 class="mb-0">Account Information</h5>
                            </div>
                            <div class="card-body">
                                <ul class="list-group list-group-flush">
                                    <li class="list-group-item d-flex justify-content-between px-0">
                                        <span>Member Since</span>
                                        <span class="text-muted">
                                            <% if (profile.created_at) { %>
                                                <%= new Date(profile.created_at).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' }) %>
                                            <% } else if (profile.joinDate) { %>
                                                <%= profile.joinDate %>
                                            <% } else { %>
                                                <%= new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' }) %>
                                            <% } %>
                                        </span>
                                    </li>
                                    <li class="list-group-item d-flex justify-content-between px-0">
                                        <span>Account Status</span>
                                        <span class="badge bg-success">Active</span>
                                    </li>
                                </ul>
                                <div class="d-grid mt-3">
                                    <button class="btn btn-outline-danger" data-bs-toggle="modal" data-bs-target="#changePasswordModal">Change Password</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Profile Details and Editing -->
                    <div class="col-md-8">
                        <div class="card border-0 shadow-sm mb-4">
                            <div class="card-header bg-light d-flex justify-content-between align-items-center">
                                <h5 class="mb-0">Personal Information</h5>
                                <button class="btn btn-sm btn-primary" id="editProfileBtn">Edit</button>
                            </div>
                            <div class="card-body">
                                <form id="profileForm" action="/player/update-profile" method="POST">
                                    <div class="row mb-3">
                                        <div class="col-md-6">
                                            <label class="form-label">Full Name</label>
                                            <input type="text" name="name" class="form-control" value="<%= profile.name %>" disabled>
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label">Email</label>
                                            <input type="email" name="email" class="form-control" value="<%= profile.email %>" readonly disabled>
                                            <small class="form-text text-muted">Your email address cannot be changed as it is used for account identification.</small>
                                        </div>
                                    </div>
                                    <div class="row mb-3">
                                        <div class="col-md-6">
                                            <label class="form-label">Phone Number</label>
                                            <input type="tel" name="phone" class="form-control" value="<%= profile.phone %>" 
                                                   pattern="[0-9]{10}" title="Phone number must be 10 digits" 
                                                   placeholder="10-digit phone number" disabled>
                                            <small class="form-text text-muted">Enter a 10-digit phone number without spaces or dashes</small>
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label">Age</label>
                                            <input type="number" name="age" class="form-control" value="<%= profile.age %>" disabled>
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Address</label>
                                        <input type="text" name="address" class="form-control" value="<%= profile.address %>" disabled>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Bio</label>
                                        <textarea name="bio" class="form-control" rows="3" disabled><%= profile.bio %></textarea>
                                    </div>
                                    <div id="saveProfileBtnContainer" class="d-none">
                                        <button type="submit" class="btn btn-success">Save Changes</button>
                                        <button type="button" class="btn btn-secondary ms-2" id="cancelEditBtn">Cancel</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                        
                        <!-- Display preferred sports section -->
                        <div class="card border-0 shadow-sm mb-4">
                            <div class="card-header bg-light">
                                <h5 class="mb-0">Preferred Sports</h5>
                            </div>
                            <div class="card-body">
                                <div class="row mb-3">
                                    <% 
                                    // Parse preferred sports from either format (array or comma-separated string)
                                    let preferredSports = [];
                                    if (profile.preferredSports && Array.isArray(profile.preferredSports)) {
                                        preferredSports = profile.preferredSports;
                                    } else if (profile.preferred_sports) {
                                        if (typeof profile.preferred_sports === 'string') {
                                            preferredSports = profile.preferred_sports.split(',').filter(s => s.trim());
                                        } else if (Array.isArray(profile.preferred_sports)) {
                                            preferredSports = profile.preferred_sports;
                                        }
                                    }
                                    
                                    // Default sports if none are set
                                    if (preferredSports.length === 0) {
                                        preferredSports = ['Basketball'];
                                    }
                                    %>
                                    
                                    <% preferredSports.forEach(sport => { %>
                                    <div class="col-md-4 mb-2">
                                        <div class="card text-center bg-light">
                                            <div class="card-body py-3">
                                                <% let icon = ''; %>
                                                <% if (sport === 'Basketball') { icon = 'bi-dribbble'; } %>
                                                <% if (sport === 'Football') { icon = 'bi-football'; } %>
                                                <% if (sport === 'Cricket') { icon = 'bi-disc'; } %>
                                                <% if (sport === 'Tennis') { icon = 'bi-circle'; } %>
                                                <% if (sport === 'Swimming') { icon = 'bi-water'; } %>
                                                <% if (sport === 'Volleyball') { icon = 'bi-circle'; } %>
                                                <% if (!icon) { icon = 'bi-trophy'; } %>
                                                <i class="bi <%= icon %> fs-4 mb-2 text-primary"></i>
                                                <p class="mb-0"><%= sport %></p>
                                            </div>
                                        </div>
                                    </div>
                                    <% }); %>
                                </div>
                                <button class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#addSportsModal">Update Sports</button>
                            </div>
                        </div>
                        
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Change Password Modal -->
<div class="modal fade" id="changePasswordModal" tabindex="-1" aria-labelledby="changePasswordModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="changePasswordModalLabel">Change Password</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="changePasswordForm" action="/player/change-password" method="POST">
                    <div class="mb-3">
                        <label for="currentPassword" class="form-label">Current Password</label>
                        <input type="password" class="form-control" id="currentPassword" name="currentPassword" required>
                    </div>
                    <div class="mb-3">
                        <label for="newPassword" class="form-label">New Password</label>
                        <input type="password" class="form-control" id="newPassword" name="newPassword" required>
                    </div>
                    <div class="mb-3">
                        <label for="confirmPassword" class="form-label">Confirm New Password</label>
                        <input type="password" class="form-control" id="confirmPassword" name="confirmPassword" required>
                    </div>
                    <div id="passwordMismatch" class="alert alert-danger d-none">
                        Passwords do not match!
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="savePasswordBtn">Change Password</button>
            </div>
        </div>
    </div>
</div>

<!-- Change Photo Modal -->
<div class="modal fade" id="changePhotoModal" tabindex="-1" aria-labelledby="changePhotoModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="changePhotoModalLabel">Change Profile Picture</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="changePhotoForm" action="/player/update-photo" method="POST" enctype="multipart/form-data">
                    <div class="mb-3">
                        <label for="photo" class="form-label">Select a new photo</label>
                        <input type="file" class="form-control" id="photo" name="photo" accept="image/*" required>
                    </div>
                    <div class="mt-3">
                        <div class="alert alert-info">
                            <small>Maximum file size: 5MB. Supported formats: JPG, PNG, GIF</small>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="savePhotoBtn">Upload Photo</button>
            </div>
        </div>
    </div>
</div>

<!-- Add Sports Modal -->
<div class="modal fade" id="addSportsModal" tabindex="-1" aria-labelledby="addSportsModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addSportsModalLabel">Manage Preferred Sports</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="addSportsForm" action="/player/update-sports" method="POST">
                    <div class="mb-3">
                        <!-- Directly list all available sports without re-parsing preferredSports -->
                        <% const allSports = ['Basketball', 'Football', 'Cricket', 'Tennis', 'Swimming', 'Volleyball', 'Badminton', 'Table Tennis', 'Hockey']; %>
                        
                        <% allSports.forEach(sport => { 
                            const isSelected = preferredSports.includes(sport);
                        %>
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" id="sport<%= sport.replace(/\\s+/g, '') %>" 
                                   name="sports" value="<%= sport %>" <%= isSelected ? 'checked' : '' %>>
                            <label class="form-check-label" for="sport<%= sport.replace(/\\s+/g, '') %>"><%= sport %></label>
                        </div>
                        <% }); %>
                    </div>
                    <div class="alert alert-info">
                        <small>Select your preferred sports. This helps us connect you with relevant teams and events.</small>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveSportsBtn">Save Preferences</button>
            </div>
        </div>
    </div>
</div>


<!-- JavaScript for Profile Page -->
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Edit profile functionality
        document.getElementById('editProfileBtn').addEventListener('click', function() {
            // Enable all form fields
            document.querySelectorAll('#profileForm input, #profileForm textarea').forEach(field => {
                if (field.name !== 'email') {
                    field.disabled = false;
                }
            });
            
            // Show save button
            document.getElementById('saveProfileBtnContainer').classList.remove('d-none');
            
            // Hide edit button
            this.classList.add('d-none');
        });
        
        // Cancel edit
        document.getElementById('cancelEditBtn').addEventListener('click', function() {
            // Disable all form fields
            document.querySelectorAll('#profileForm input, #profileForm textarea').forEach(field => {
                field.disabled = true;
            });
            
            // Hide save button
            document.getElementById('saveProfileBtnContainer').classList.add('d-none');
            
            // Show edit button
            document.getElementById('editProfileBtn').classList.remove('d-none');
        });
        
        // Handle password validation
        document.getElementById('savePasswordBtn').addEventListener('click', function() {
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            
            if (newPassword !== confirmPassword) {
                document.getElementById('passwordMismatch').classList.remove('d-none');
                return false;
            } else {
                document.getElementById('passwordMismatch').classList.add('d-none');
                document.getElementById('changePasswordForm').submit();
            }
        });
        
        // Handle photo upload
        document.getElementById('savePhotoBtn').addEventListener('click', function() {
            const photoInput = document.getElementById('photo');
            
            if (photoInput.files.length === 0) {
                alert('Please select a file to upload');
                return false;
            }
            
            // Submit the form
            document.getElementById('changePhotoForm').submit();
        });
        
        // Complete profile button
        const completeProfileBtn = document.getElementById('completeProfileBtn');
        if (completeProfileBtn) {
            completeProfileBtn.addEventListener('click', function() {
                document.getElementById('editProfileBtn').click();
                window.scrollTo(0, document.getElementById('profileForm').offsetTop - 100);
            });
        }
    });
</script> 